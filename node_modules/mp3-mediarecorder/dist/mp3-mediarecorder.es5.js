var privateData=new WeakMap,wrappers=new WeakMap;function pd(a){var b=privateData.get(a);return console.assert(null!=b,"'this' is expected an Event object, but got",a),b}function setCancelFlag(a){return null==a.passiveListener?void(!a.event.cancelable||(a.canceled=!0,"function"==typeof a.event.preventDefault&&a.event.preventDefault())):void("undefined"!=typeof console&&"function"==typeof console.error&&console.error("Unable to preventDefault inside passive event listener invocation.",a.passiveListener))}function Event$1(a,b){privateData.set(this,{eventTarget:a,event:b,eventPhase:2,currentTarget:a,canceled:!1,stopped:!1,immediateStopped:!1,passiveListener:null,timeStamp:b.timeStamp||Date.now()}),Object.defineProperty(this,"isTrusted",{value:!1,enumerable:!0});for(var c,d=Object.keys(b),e=0;e<d.length;++e)c=d[e],c in this||Object.defineProperty(this,c,defineRedirectDescriptor(c))}Event$1.prototype={get type(){return pd(this).event.type},get target(){return pd(this).eventTarget},get currentTarget(){return pd(this).currentTarget},composedPath:function(){var a=pd(this).currentTarget;return null==a?[]:[a]},get NONE(){return 0},get CAPTURING_PHASE(){return 1},get AT_TARGET(){return 2},get BUBBLING_PHASE(){return 3},get eventPhase(){return pd(this).eventPhase},stopPropagation:function(){var a=pd(this);a.stopped=!0,"function"==typeof a.event.stopPropagation&&a.event.stopPropagation()},stopImmediatePropagation:function(){var a=pd(this);a.stopped=!0,a.immediateStopped=!0,"function"==typeof a.event.stopImmediatePropagation&&a.event.stopImmediatePropagation()},get bubbles(){return!!pd(this).event.bubbles},get cancelable(){return!!pd(this).event.cancelable},preventDefault:function(){setCancelFlag(pd(this))},get defaultPrevented(){return pd(this).canceled},get composed(){return!!pd(this).event.composed},get timeStamp(){return pd(this).timeStamp},get srcElement(){return pd(this).eventTarget},get cancelBubble(){return pd(this).stopped},set cancelBubble(a){if(a){var b=pd(this);b.stopped=!0,"boolean"==typeof b.event.cancelBubble&&(b.event.cancelBubble=!0)}},get returnValue(){return!pd(this).canceled},set returnValue(a){a||setCancelFlag(pd(this))},initEvent:function(){}},Object.defineProperty(Event$1.prototype,"constructor",{value:Event$1,configurable:!0,writable:!0}),"undefined"!=typeof window&&"undefined"!=typeof window.Event&&(Object.setPrototypeOf(Event$1.prototype,window.Event.prototype),wrappers.set(window.Event.prototype,Event$1));function defineRedirectDescriptor(a){return{get:function(){return pd(this).event[a]},set:function(b){pd(this).event[a]=b},configurable:!0,enumerable:!0}}function defineCallDescriptor(a){return{value:function(){var b=pd(this).event;return b[a].apply(b,arguments)},configurable:!0,enumerable:!0}}function defineWrapper(a,b){function c(b,c){a.call(this,b,c)}var d=Object.keys(b);if(0===d.length)return a;c.prototype=Object.create(a.prototype,{constructor:{value:c,configurable:!0,writable:!0}});for(var e,f=0;f<d.length;++f)if(e=d[f],!(e in a.prototype)){var g=Object.getOwnPropertyDescriptor(b,e),h="function"==typeof g.value;Object.defineProperty(c.prototype,e,h?defineCallDescriptor(e):defineRedirectDescriptor(e))}return c}function getWrapper(a){if(null==a||a===Object.prototype)return Event$1;var b=wrappers.get(a);return null==b&&(b=defineWrapper(getWrapper(Object.getPrototypeOf(a)),a),wrappers.set(a,b)),b}function wrapEvent(a,b){var c=getWrapper(Object.getPrototypeOf(b));return new c(a,b)}function isStopped(a){return pd(a).immediateStopped}function setEventPhase(a,b){pd(a).eventPhase=b}function setCurrentTarget(a,b){pd(a).currentTarget=b}function setPassiveListener(a,b){pd(a).passiveListener=b}var listenersMap=new WeakMap,CAPTURE=1,BUBBLE=2,ATTRIBUTE=3;function isObject(a){return null!==a&&"object"==typeof a}function getListeners(a){var b=listenersMap.get(a);if(null==b)throw new TypeError("'this' is expected an EventTarget object, but got another value.");return b}function defineEventAttributeDescriptor(a){return{get:function(){for(var b=getListeners(this),c=b.get(a);null!=c;){if(c.listenerType===ATTRIBUTE)return c.listener;c=c.next}return null},set:function(b){"function"==typeof b||isObject(b)||(b=null);for(var c=getListeners(this),d=null,e=c.get(a);null!=e;)e.listenerType===ATTRIBUTE?null===d?null===e.next?c.delete(a):c.set(a,e.next):d.next=e.next:d=e,e=e.next;if(null!==b){var f={listener:b,listenerType:ATTRIBUTE,passive:!1,once:!1,next:null};null===d?c.set(a,f):d.next=f}},configurable:!0,enumerable:!0}}function defineEventAttribute(a,b){Object.defineProperty(a,"on"+b,defineEventAttributeDescriptor(b))}function defineCustomEventTarget(a){function b(){EventTarget.call(this)}b.prototype=Object.create(EventTarget.prototype,{constructor:{value:b,configurable:!0,writable:!0}});for(var c=0;c<a.length;++c)defineEventAttribute(b.prototype,a[c]);return b}function EventTarget(){var a=arguments;if(this instanceof EventTarget)return void listenersMap.set(this,new Map);if(1===arguments.length&&Array.isArray(arguments[0]))return defineCustomEventTarget(arguments[0]);if(0<arguments.length){for(var b=Array(arguments.length),c=0;c<arguments.length;++c)b[c]=a[c];return defineCustomEventTarget(b)}throw new TypeError("Cannot call a class as a function")}EventTarget.prototype={addEventListener:function(a,b,c){if(null!=b){if("function"!=typeof b&&!isObject(b))throw new TypeError("'listener' should be a function or an object.");var d=getListeners(this),e=isObject(c),f=e?!!c.capture:!!c,g=f?CAPTURE:BUBBLE,h={listener:b,listenerType:g,passive:e&&!!c.passive,once:e&&!!c.once,next:null},i=d.get(a);if(void 0===i)return void d.set(a,h);for(var j=null;null!=i;){if(i.listener===b&&i.listenerType===g)return;j=i,i=i.next}j.next=h}},removeEventListener:function(a,b,c){if(null!=b)for(var d=getListeners(this),e=isObject(c)?!!c.capture:!!c,f=e?CAPTURE:BUBBLE,g=null,h=d.get(a);null!=h;){if(h.listener===b&&h.listenerType===f)return void(null===g?null===h.next?d.delete(a):d.set(a,h.next):g.next=h.next);g=h,h=h.next}},dispatchEvent:function(a){if(null==a||"string"!=typeof a.type)throw new TypeError("\"event.type\" should be a string.");var b=getListeners(this),c=a.type,d=b.get(c);if(null==d)return!0;for(var e=wrapEvent(this,a),f=null;null!=d;){if(d.once?null===f?null===d.next?b.delete(c):b.set(c,d.next):f.next=d.next:f=d,setPassiveListener(e,d.passive?d.listener:null),"function"==typeof d.listener)try{d.listener.call(this,e)}catch(a){"undefined"!=typeof console&&"function"==typeof console.error&&console.error(a)}else d.listenerType!==ATTRIBUTE&&"function"==typeof d.listener.handleEvent&&d.listener.handleEvent(e);if(isStopped(e))break;d=d.next}return setPassiveListener(e,null),setEventPhase(e,0),setCurrentTarget(e,null),!e.defaultPrevented}},Object.defineProperty(EventTarget.prototype,"constructor",{value:EventTarget,configurable:!0,writable:!0}),"undefined"!=typeof window&&"undefined"!=typeof window.EventTarget&&Object.setPrototypeOf(EventTarget.prototype,window.EventTarget.prototype);var PostMessageType;(function(a){a.INIT_WORKER="INIT_WORKER",a.DATA_AVAILABLE="DATA_AVAILABLE",a.START_RECORDING="START_RECORDING",a.STOP_RECORDING="STOP_RECORDING",a.ERROR="ERROR",a.BLOB_READY="BLOB_READY",a.WORKER_RECORDING="WORKER_RECORDING",a.WORKER_READY="WORKER_READY"})(PostMessageType||(PostMessageType={}));var initMessage=function(a){return{type:PostMessageType.INIT_WORKER,wasmURL:a}},startRecordingMessage=function(a){return{type:PostMessageType.START_RECORDING,config:a}},dataAvailableMessage=function(a){return{type:PostMessageType.DATA_AVAILABLE,data:a}},stopRecordingMessage=function(){return{type:PostMessageType.STOP_RECORDING}},mp3EncoderWorker=function(){var a,b,c,d=134217728,e=65536,f=self,g=new WebAssembly.Memory({initial:d/e,maximum:d/e}),h=5242880,i=!1,j=function(a,b){return fetch(a).then(function(a){return a.arrayBuffer()}).then(function(a){return WebAssembly.instantiate(a,b)})},k=function(a,b){return WebAssembly.instantiateStreaming?WebAssembly.instantiateStreaming(fetch(a),b).catch(function(){return j(a,b)}):j(a,b)},l=function(){var a=Math.pow,b=function(a){var b=h;return h+=a,b},c={memory:g,sbrk:b,exit:function(){f.postMessage({type:"ERROR",error:"internal"})},pow:a,powf:a,exp:Math.exp,sqrtf:Math.sqrt,cos:Math.cos,log:Math.log,sin:Math.sin};return{env:c}},m=function(d){if(i=!0,b=a.vmsg_init(d.sampleRate),!b||!a)throw new Error("init_failed");var e=new Uint32Array(g.buffer,b,1)[0];c=new Float32Array(g.buffer,e)},n=function(){if(i=!1,0>a.vmsg_flush(b))throw new Error("flush_failed");var c=new Uint32Array(g.buffer,b+4,1)[0],d=new Uint32Array(g.buffer,b+8,1)[0],e=new Uint8Array(g.buffer,c,d),f=new Blob([e],{type:"audio/mpeg"});return a.vmsg_free(b),f},o=function(d){if(i){c.set(d);var e=a.vmsg_encode(b,d.length);if(0>e)throw new Error("encoding_failed")}};f.onmessage=function(b){var c=b.data;try{switch(c.type){case"INIT_WORKER":{var d=l();k(c.wasmURL,d).then(function(b){a=b.instance.exports,f.postMessage({type:"WORKER_READY"})}).catch(function(a){f.postMessage({type:"ERROR",error:a.message})});break}case"START_RECORDING":{m(c.config),f.postMessage({type:"WORKER_RECORDING"});break}case"DATA_AVAILABLE":{o(c.data);break}case"STOP_RECORDING":{var e=n();f.postMessage({type:"BLOB_READY",blob:e});break}}}catch(a){f.postMessage({type:"ERROR",error:a.message})}}},MP3_MIME_TYPE="audio/mpeg",SafeAudioContext=window.AudioContext||window.webkitAudioContext,createGain=function(a){return(a.createGain||a.createGainNode).call(a)},createScriptProcessor=function(a){return(a.createScriptProcessor||a.createJavaScriptNode).call(a,4096,1,1)},getMp3MediaRecorder=function(a){var b=new Blob(["("+mp3EncoderWorker.toString()+")()"],{type:"application/javascript"}),c=new Worker(URL.createObjectURL(b)),d=function(a){function b(b,d){var e=this;void 0===d&&(d={}),a.call(this),this.mimeType=MP3_MIME_TYPE,this.state="inactive",this.audioBitsPerSecond=0,this.videoBitsPerSecond=0,this.onWorkerMessage=function(a){var b=a.data;switch(b.type){case PostMessageType.WORKER_RECORDING:{var c=new Event("start");e.dispatchEvent(c),e.state="recording";break}case PostMessageType.ERROR:{var d=new DOMException(b.error),f=new Event("error");f.error=d;var g=window.MediaRecorderErrorEvent?new MediaRecorderErrorEvent("error",{error:d}):f;e.dispatchEvent(g),e.state="inactive";break}case PostMessageType.BLOB_READY:{var h=new Event("stop"),i=new Event("dataavailable");i.data=b.blob,i.timecode=Date.now();var j=window.BlobEvent?new BlobEvent("dataavailable",{data:b.blob,timecode:Date.now()}):i;e.dispatchEvent(j),e.dispatchEvent(h),e.state="inactive";break}}};var f=Object.assign({},d,{audioContext:new SafeAudioContext});this.stream=b,this.audioContext=f.audioContext,this.sourceNode=this.audioContext.createMediaStreamSource(b),this.gainNode=createGain(this.audioContext),this.gainNode.gain.value=1,this.processorNode=createScriptProcessor(this.audioContext),this.sourceNode.connect(this.gainNode),this.gainNode.connect(this.processorNode),c.onmessage=this.onWorkerMessage}return a&&(b.__proto__=a),b.prototype=Object.create(a&&a.prototype),b.prototype.constructor=b,b.prototype.start=function(){this.processorNode.onaudioprocess=function(a){c.postMessage(dataAvailableMessage(a.inputBuffer.getChannelData(0)))},this.processorNode.connect(this.audioContext.destination),this.audioContext.resume(),c.postMessage(startRecordingMessage({sampleRate:this.audioContext.sampleRate}))},b.prototype.stop=function(){this.processorNode.disconnect(),this.audioContext.suspend(),c.postMessage(stopRecordingMessage())},b.prototype.pause=function(){this.audioContext.suspend(),this.state="paused",this.dispatchEvent(new Event("pause"))},b.prototype.resume=function(){this.audioContext.resume(),this.state="recording",this.dispatchEvent(new Event("resume"))},b.prototype.requestData=function(){},b}(EventTarget);return d.isTypeSupported=function(a){return a===MP3_MIME_TYPE},defineEventAttribute(d.prototype,"start"),defineEventAttribute(d.prototype,"stop"),defineEventAttribute(d.prototype,"pause"),defineEventAttribute(d.prototype,"resume"),defineEventAttribute(d.prototype,"dataavailable"),defineEventAttribute(d.prototype,"error"),new Promise(function(b,e){var f=new URL(a.wasmURL,window.location.origin).href;c.postMessage(initMessage(f)),c.onmessage=function(a){var c=a.data;if(c.type===PostMessageType.WORKER_READY)b(d);else{var f=c.type===PostMessageType.ERROR?c.error:"Unknown error occurred ";e(f)}}})};export{getMp3MediaRecorder};
//# sourceMappingURL=mp3-mediarecorder.es5.js.map
